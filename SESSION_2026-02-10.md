# Session Notes: 2026-02-10

## Overview
Debugging and fixing Docker deployment issues, UI problems, and Weather API errors on VPS with Nginx Proxy Manager.

---

## Issues Fixed

### 1. Docker Build Compilation Errors ‚úÖ

**Problem**: Production build failing with TypeScript/NextAuth/Prisma errors

**Root Causes**:
- Code using NextAuth v4 API with v5 installed
- Prisma type casting issues with JSON fields
- Missing TypeScript type definitions for custom User properties

**Solutions**:
- Updated all `getServerSession(authOptions)` ‚Üí `auth()`
- Added proper Prisma type casting: `eventData as Prisma.InputJsonValue`
- Extended NextAuth types in `/types/next-auth.d.ts`
- Added `@ts-expect-error` for adapter type incompatibility

**Files Modified**:
- `/app/api/analytics/track/route.ts`
- `/lib/auth.ts`
- `/types/next-auth.d.ts`
- `/components/auth/UserMenu.tsx`

---

### 2. UI Contrast Issues ‚úÖ

**Problem**: Text invisible in analytics dashboard and trip views (gray text on light background)

**Root Cause**: Dark mode classes (`dark:text-gray-300`) causing light text on light backgrounds

**Solution**: Systematically removed all `dark:` classes from affected components

**Files Modified**:
- `/app/[locale]/admin/analytics/page.tsx`
- `/app/[locale]/admin/analytics/components/*.tsx`
- Various trip view components

**Commands Used**:
```bash
sed -i 's/dark:text-gray-300/text-gray-900/g' file.tsx
sed -i 's/dark:bg-gray-800/bg-white/g' file.tsx
```

---

### 3. Docker Network - External API Access ‚úÖ

**Problem**: Container couldn't reach external APIs (Weather, Geolocation)
- Error: `Connect Timeout Error`

**Root Cause**: Docker container had no DNS configuration

**Solution**: Added DNS servers to docker-compose.yml

```yaml
services:
  tripcalc:
    dns:
      - 8.8.8.8
      - 8.8.4.4
```

**File Modified**: `/docker-compose.yml`

---

### 4. Geolocation for VPS/Docker ‚úÖ

**Problem**: Country statistics showing only "LOCAL" - Vercel headers not available

**Root Cause**: Running on VPS (not Vercel), no geolocation headers

**Solution**:
- Implemented ipapi.co API fallback (free tier: 30k requests/month)
- Made `getGeolocationFromHeaders()` async
- Added proper error handling and timeouts
- Created country flag utilities

**Files Modified**:
- `/lib/analytics/geolocation.ts` - Added async fallback
- `/lib/utils/country-flags.ts` - NEW FILE
- `/app/api/analytics/track/route.ts` - Updated to await geo data
- `/app/[locale]/admin/analytics/page.tsx` - Display country flags

---

### 5. Weather API Date Range Error ‚úÖ

**Problem**:
```
Open-Meteo API error: 400
Parameter 'start_date' is out of allowed range from 2025-11-09 to 2026-02-25
```

**Root Cause**:
- User trying to get forecast for March 15, 2026
- Open-Meteo only allows forecast up to **16 days in future**

**Solution**:
1. Added date validation in `/lib/weather/open-meteo.ts`:
   - Check if startDate > 16 days ‚Üí throw descriptive error
   - Auto-adjust endDate if beyond limit

2. Enhanced error handling in `/components/trips/WeatherCard.tsx`:
   - Changed error state from `boolean` to `string | null`
   - Extract error message from API response
   - Display yellow warning card with specific error message

3. Added translations:
   - `weather.errorTitle` in en.json + es.json

**Files Modified**:
- `/lib/weather/open-meteo.ts` - Date validation logic
- `/components/trips/WeatherCard.tsx` - Error display UI
- `/messages/en.json` - Translation
- `/messages/es.json` - Translation

**Code Added**:
```typescript
// Validate forecast range
const maxForecastDate = new Date();
maxForecastDate.setDate(maxForecastDate.getDate() + 16);
const maxForecastDateStr = maxForecastDate.toISOString().split('T')[0];

if (startDate > maxForecastDateStr) {
  throw new Error(
    `Weather forecast is only available up to 16 days in the future (until ${maxForecastDateStr}). ` +
    `Your trip starts on ${startDate}.`
  );
}

const adjustedEndDate = endDate > maxForecastDateStr ? maxForecastDateStr : endDate;
```

---

## Environment Details

### VPS Configuration
- **Platform**: VPS with Docker
- **Reverse Proxy**: Nginx Proxy Manager
- **Container**: `tripcalc-prod`
- **Ports**: 3020:3000 (external:internal)
- **Dockerfile**: `Dockerfile.debian`
- **Docker Compose**: Custom with DNS configuration

### Key Configuration
```yaml
services:
  tripcalc:
    build:
      context: .
      dockerfile: Dockerfile.debian
    container_name: tripcalc-prod
    ports:
      - "3020:3000"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
```

### Nginx Proxy Manager
**Current Setup**: NPM in Docker, TripCalc in Docker
**Network**: Likely npm_default or similar
**Configuration Needed**: Headers for geolocation
```nginx
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
```

---

## Still Pending

### üî¥ High Priority

1. **Console Errors** (needs debugging in production):
   - "useAnalytics must be used within AnalyticsProvider"
   - "INVALID_MESSAGE" (missing translation keys)
   - Some geolocation API timeouts on first request

2. **Nginx Proxy Manager Headers**:
   - Verify X-Real-IP and X-Forwarded-For are being passed
   - Test geolocation accuracy with real traffic
   - Check logs: `docker logs tripcalc-prod | grep -i "x-forwarded"`

3. **Cleanup**:
   - Remove debug `console.log` statements
   - Verify all translations exist
   - Test all calculators with various inputs

---

## Testing Checklist

### ‚úÖ Completed
- [x] Docker build compiles successfully
- [x] Text visible in analytics dashboard
- [x] Text visible in trip views
- [x] External API calls working (Weather, Geolocation)
- [x] Weather API date validation working
- [x] Country flags displaying in analytics

### ‚è≥ Needs Testing in Production
- [ ] Weather forecast for trips within 16 days
- [ ] Weather error message for trips beyond 16 days
- [ ] Geolocation accuracy with real IPs
- [ ] Analytics tracking from various countries
- [ ] All calculators functional
- [ ] Trip creation and saving

---

## Deployment Steps (for next time)

```bash
# 1. Local: Commit changes
git add .
git commit -m "fix: weather API error handling and Docker deployment fixes"
git push

# 2. VPS: Pull and rebuild
ssh user@vps
cd /path/to/tripcalc
git pull
docker compose build
docker compose restart tripcalc-prod

# 3. Monitor logs
docker logs -f tripcalc-prod

# 4. Test
# - Visit https://tripcalc.site
# - Create a trip with dates within 16 days
# - Check weather loads correctly
# - Visit /admin/analytics
# - Check for console errors in browser DevTools
```

---

## Resources

### Documentation Files
- `CLAUDE.md` - Main project documentation (updated)
- `NGINX_PROXY_MANAGER_SETUP.md` - NPM configuration guide
- `docker-compose.yml` - Container configuration
- `DEPLOYMENT_VPS.md` - VPS deployment guide

### External APIs
- **Open-Meteo**: https://open-meteo.com/ (Weather, free, 10k calls/day)
- **ipapi.co**: https://ipapi.co/ (Geolocation, free, 30k requests/month)

### Key Commands
```bash
# Build
npm run build

# Docker
docker compose build
docker compose up -d
docker compose restart tripcalc-prod
docker logs -f tripcalc-prod
docker stats tripcalc-prod

# Database
npm run db:generate
npm run db:migrate
npm run db:studio
```

---

## Notes for Next Session

1. **First Priority**: Test in production and verify everything works
2. **Check Logs**: Look for any remaining errors or warnings
3. **NPM Headers**: Verify geolocation is getting real country data
4. **Weather Testing**: Create trips with various date ranges
5. **Analytics**: Monitor if tracking events are being recorded correctly

### Questions to Answer
- Are X-Forwarded-For headers being passed by NPM?
- Is geolocation showing real country data or still "LOCAL"?
- Are there any console errors in production?
- Is weather working for all supported cities?

---

**Session Duration**: ~3 hours
**Status**: ‚úÖ Build successful, ready for deployment testing
**Next Step**: Deploy to VPS and test in production
